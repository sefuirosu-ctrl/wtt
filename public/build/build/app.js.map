{"version":3,"file":"app.js","sources":["../js/debug.js","../../client/core/EventBus.js","../../client/engine/GameLoop.js","../../client/engine/BoardState.js","../../client/gameplay/canvas/CanvasRenderLoop.js","../../client/gameplay/canvas/BoardLayer.js","../../client/gameplay/canvas/PieceAnimator.js","../../client/gameplay/canvas/DropAnimator.js","../../client/gameplay/canvas/PieceLayer.js","../../client/gameplay/canvas/fx/FXPriority.js","../../client/gameplay/canvas/fx/FXBudgetController.js","../../client/gameplay/canvas/CanvasBoardRenderer.js","../../client/gameplay/canvas/CanvasConfig.js","../js/main.js"],"sourcesContent":["// public/js/debug.js\r\n// Debug utilities (ES module)\r\n\r\nexport function initDebug() {\r\n  console.log('[DEBUG] Debug system initialized');\r\n\r\n  window.__WOT_DEBUG__ = {\r\n    ping() {\r\n      console.log('[DEBUG] pong');\r\n    }\r\n  };\r\n}\r\n","// client/core/EventBus.js\n\n/**\n * EventBus\n * ----------------------------------------------------\n * Minimal, deterministic event bus.\n *\n * Canon intent:\n * - Centralized event dispatch\n * - Systems publish gameplay events; UI/visual layers consume\n * - No arbitrary code evaluation\n */\n\nexport class EventBus {\n    constructor() {\n        /** @type {Map<string, Set<Function>>} */\n        this._listeners = new Map();\n    }\n\n    /**\n     * Subscribe.\n     * @param {string} eventName\n     * @param {(payload:any)=>void} handler\n     * @returns {() => void} unsubscribe\n     */\n    on(eventName, handler) {\n        if (!eventName || typeof handler !== 'function') {\n            console.warn('[EventBus] Invalid subscription', eventName, handler);\n            return () => {};\n        }\n\n        const set = this._listeners.get(eventName) ?? new Set();\n        set.add(handler);\n        this._listeners.set(eventName, set);\n\n        return () => this.off(eventName, handler);\n    }\n\n    /**\n     * Unsubscribe.\n     * @param {string} eventName\n     * @param {(payload:any)=>void} handler\n     */\n    off(eventName, handler) {\n        const set = this._listeners.get(eventName);\n        if (!set) return;\n        set.delete(handler);\n        if (set.size === 0) this._listeners.delete(eventName);\n    }\n\n    /**\n     * Emit.\n     * @param {string} eventName\n     * @param {any} payload\n     */\n    emit(eventName, payload = undefined) {\n        const set = this._listeners.get(eventName);\n        if (!set || set.size === 0) return;\n\n        // Deterministic iteration order.\n        for (const handler of Array.from(set)) {\n            try {\n                handler(payload);\n            } catch (err) {\n                console.error(`[EventBus] Listener error for ${eventName}`, err);\n            }\n        }\n    }\n\n    /**\n     * Debug helper.\n     */\n    getListenerCount(eventName) {\n        return this._listeners.get(eventName)?.size ?? 0;\n    }\n}\n","// client/engine/GameLoop.js\n// Canon: single responsibility = time + tick driving. No gameplay logic.\n\nexport class GameLoop {\n  constructor(options = {}) {\n    const {\n      // onTick(deltaMs, nowMs) optional callback\n      onTick = null,\n      // target FPS cap (optional). If null -> uncapped RAF\n      maxFps = null,\n      // start paused\n      startPaused = false,\n    } = options;\n\n    // ---- Time model ----\n    this._running = false;\n    this._paused = !!startPaused;\n\n    this._lastNow = 0;\n    this._rafId = null;\n\n    // FPS cap\n    this._maxFps = (typeof maxFps === \"number\" && maxFps > 0) ? maxFps : null;\n    this._minFrameMs = this._maxFps ? (1000 / this._maxFps) : 0;\n\n    // ---- Systems (optional, future-proof) ----\n    this._systems = [];\n\n    // ---- Callback guard (THIS FIXES YOUR CRASH) ----\n    this.onTick = (typeof onTick === \"function\") ? onTick : () => {};\n  }\n\n  /* =========================\n     Public API\n  ========================= */\n\n  start() {\n    if (this._running) return;\n    this._running = true;\n\n    // initialize last time\n    this._lastNow = performance.now();\n    this._rafId = requestAnimationFrame(this._tick);\n  }\n\n  stop() {\n    this._running = false;\n    if (this._rafId) cancelAnimationFrame(this._rafId);\n    this._rafId = null;\n  }\n\n  pause() {\n    this._paused = true;\n  }\n\n  resume() {\n    // reset time delta to avoid huge spike\n    this._paused = false;\n    this._lastNow = performance.now();\n  }\n\n  setOnTick(fn) {\n    this.onTick = (typeof fn === \"function\") ? fn : () => {};\n  }\n\n  addSystem(system) {\n    // system.update(deltaMs, nowMs) optional\n    if (system && !this._systems.includes(system)) {\n      this._systems.push(system);\n    }\n  }\n\n  removeSystem(system) {\n    this._systems = this._systems.filter(s => s !== system);\n  }\n\n  /* =========================\n     Internal tick\n  ========================= */\n\n  _tick = (now) => {\n    if (!this._running) return;\n\n    const delta = now - this._lastNow;\n\n    // FPS cap: skip frame if too soon\n    if (this._minFrameMs && delta < this._minFrameMs) {\n      this._rafId = requestAnimationFrame(this._tick);\n      return;\n    }\n\n    this._lastNow = now;\n\n    if (!this._paused) {\n      const deltaMs = Math.max(0, delta);\n\n      // 1) external callback (safe всегда)\n      this.onTick(deltaMs, now);\n\n      // 2) optional systems\n      for (const s of this._systems) {\n        if (s && typeof s.update === \"function\") {\n          s.update(deltaMs, now);\n        }\n      }\n    }\n\n    this._rafId = requestAnimationFrame(this._tick);\n  };\n}\n","// client/engine/BoardState.js\n\n/**\n * BoardState\n * ----------------------------------------------------\n * Minimal deterministic Tetris board state + active piece.\n * This is Stage 6.1.A bootstrap implementation:\n * - Enough to spawn, move, rotate, drop, lock, clear lines\n * - Exposes clone() and getBoardSnapshot() for CanvasBoardRenderer/BoardLayer\n * - Implements the method surface expected by BoardSystem so\n *   skills/pets can be wired later without refactor.\n */\n\nconst PIECES = {\n    I: [\n        // rot 0\n        [{ x: -1, y: 0 }, { x: 0, y: 0 }, { x: 1, y: 0 }, { x: 2, y: 0 }],\n        // rot 1\n        [{ x: 1, y: -1 }, { x: 1, y: 0 }, { x: 1, y: 1 }, { x: 1, y: 2 }],\n        // rot 2\n        [{ x: -1, y: 1 }, { x: 0, y: 1 }, { x: 1, y: 1 }, { x: 2, y: 1 }],\n        // rot 3\n        [{ x: 0, y: -1 }, { x: 0, y: 0 }, { x: 0, y: 1 }, { x: 0, y: 2 }]\n    ],\n    O: [\n        [{ x: 0, y: 0 }, { x: 1, y: 0 }, { x: 0, y: 1 }, { x: 1, y: 1 }],\n        [{ x: 0, y: 0 }, { x: 1, y: 0 }, { x: 0, y: 1 }, { x: 1, y: 1 }],\n        [{ x: 0, y: 0 }, { x: 1, y: 0 }, { x: 0, y: 1 }, { x: 1, y: 1 }],\n        [{ x: 0, y: 0 }, { x: 1, y: 0 }, { x: 0, y: 1 }, { x: 1, y: 1 }]\n    ],\n    T: [\n        [{ x: -1, y: 0 }, { x: 0, y: 0 }, { x: 1, y: 0 }, { x: 0, y: 1 }],\n        [{ x: 0, y: -1 }, { x: 0, y: 0 }, { x: 0, y: 1 }, { x: 1, y: 0 }],\n        [{ x: -1, y: 0 }, { x: 0, y: 0 }, { x: 1, y: 0 }, { x: 0, y: -1 }],\n        [{ x: 0, y: -1 }, { x: 0, y: 0 }, { x: 0, y: 1 }, { x: -1, y: 0 }]\n    ],\n    S: [\n        [{ x: 0, y: 0 }, { x: 1, y: 0 }, { x: -1, y: 1 }, { x: 0, y: 1 }],\n        [{ x: 0, y: -1 }, { x: 0, y: 0 }, { x: 1, y: 0 }, { x: 1, y: 1 }],\n        [{ x: 0, y: 0 }, { x: 1, y: 0 }, { x: -1, y: 1 }, { x: 0, y: 1 }],\n        [{ x: 0, y: -1 }, { x: 0, y: 0 }, { x: 1, y: 0 }, { x: 1, y: 1 }]\n    ],\n    Z: [\n        [{ x: -1, y: 0 }, { x: 0, y: 0 }, { x: 0, y: 1 }, { x: 1, y: 1 }],\n        [{ x: 1, y: -1 }, { x: 1, y: 0 }, { x: 0, y: 0 }, { x: 0, y: 1 }],\n        [{ x: -1, y: 0 }, { x: 0, y: 0 }, { x: 0, y: 1 }, { x: 1, y: 1 }],\n        [{ x: 1, y: -1 }, { x: 1, y: 0 }, { x: 0, y: 0 }, { x: 0, y: 1 }]\n    ],\n    J: [\n        [{ x: -1, y: 0 }, { x: 0, y: 0 }, { x: 1, y: 0 }, { x: -1, y: 1 }],\n        [{ x: 0, y: -1 }, { x: 0, y: 0 }, { x: 0, y: 1 }, { x: 1, y: 1 }],\n        [{ x: -1, y: 0 }, { x: 0, y: 0 }, { x: 1, y: 0 }, { x: 1, y: -1 }],\n        [{ x: 0, y: -1 }, { x: 0, y: 0 }, { x: 0, y: 1 }, { x: -1, y: -1 }]\n    ],\n    L: [\n        [{ x: -1, y: 0 }, { x: 0, y: 0 }, { x: 1, y: 0 }, { x: 1, y: 1 }],\n        [{ x: 0, y: -1 }, { x: 0, y: 0 }, { x: 0, y: 1 }, { x: 1, y: -1 }],\n        [{ x: -1, y: 0 }, { x: 0, y: 0 }, { x: 1, y: 0 }, { x: -1, y: -1 }],\n        [{ x: 0, y: -1 }, { x: 0, y: 0 }, { x: 0, y: 1 }, { x: -1, y: 1 }]\n    ]\n};\n\nfunction mulberry32(seed) {\n    let t = seed >>> 0;\n    return function () {\n        t += 0x6D2B79F5;\n        let r = Math.imul(t ^ (t >>> 15), 1 | t);\n        r ^= r + Math.imul(r ^ (r >>> 7), 61 | r);\n        return ((r ^ (r >>> 14)) >>> 0) / 4294967296;\n    };\n}\n\nexport class BoardState {\n    constructor({ width = 10, height = 20, seed = 1 } = {}) {\n        this.width = width;\n        this.height = height;\n\n        /** @type {(null|{type:string})[][]} */\n        this.grid = Array.from({ length: height }, () =>\n            Array.from({ length: width }, () => null)\n        );\n\n        this._rng = mulberry32(seed);\n        this._bag = [];\n\n        this.active = null; // {type, x, y, rot}\n        this.hold = null;\n        this.holdUsed = false;\n\n        this.gameOver = false;\n\n        // Gravity model (ms per row). Stage 6.1 uses a constant baseline.\n        this.gravityMs = 800;\n        this.softDropMultiplier = 20;\n        this._gravityTimer = 0;\n\n        this.spawnPiece();\n    }\n\n    // ==================================================\n    // SNAPSHOT (for Canvas renderer)\n    // ==================================================\n\n    /**\n     * Returns board snapshot in the format expected by BoardLayer\n     * @returns {{ width: number, height: number, cells: Array }}\n     */\n    clone() {\n        return {\n            width: this.width,\n            height: this.height,\n            cells: this.grid.map(row => row.map(c => (c ? { type: c.type } : null)))\n        };\n    }\n\n    /**\n     * Alias for clone() - used by BoardSystem interface\n     * @returns {{ width: number, height: number, cells: Array }}\n     */\n    getBoardSnapshot() {\n        return this.clone();\n    }\n\n    getActivePieceSnapshot() {\n        if (!this.active) return null;\n        return {\n            type: this.active.type,\n            position: { x: this.active.x, y: this.active.y },\n            blocks: this._getBlocks(this.active.type, this.active.rot)\n        };\n    }\n\n    getGhostPieceSnapshot() {\n        if (!this.active) return null;\n        const ghost = { ...this.active };\n        while (this._canPlace(ghost.type, ghost.x, ghost.y + 1, ghost.rot)) {\n            ghost.y++;\n        }\n        return {\n            type: ghost.type,\n            position: { x: ghost.x, y: ghost.y },\n            blocks: this._getBlocks(ghost.type, ghost.rot)\n        };\n    }\n\n    // ==================================================\n    // UPDATE\n    // ==================================================\n\n    /**\n     * @param {number} deltaMs\n     * @param {{ softDrop?:boolean }} input\n     * @returns {{ moved?:boolean, touchedGround?:boolean, locked?:boolean, linesCleared?:number }}\n     */\n    update(deltaMs, input = {}) {\n        if (this.gameOver) return {};\n        if (!this.active) return {};\n\n        const gravityStep = input.softDrop\n            ? this.gravityMs / this.softDropMultiplier\n            : this.gravityMs;\n\n        this._gravityTimer += deltaMs;\n        let moved = false;\n\n        while (this._gravityTimer >= gravityStep) {\n            this._gravityTimer -= gravityStep;\n            const res = this._stepDown();\n            moved = moved || res.moved;\n            if (res.touchedGround) {\n                return { moved, touchedGround: true };\n            }\n        }\n\n        return { moved };\n    }\n\n    // ==================================================\n    // INPUT ACTIONS (called by controller)\n    // ==================================================\n\n    move(dx) {\n        if (!this.active) return false;\n        const nextX = this.active.x + dx;\n        if (this._canPlace(this.active.type, nextX, this.active.y, this.active.rot)) {\n            this.active.x = nextX;\n            return true;\n        }\n        return false;\n    }\n\n    rotate(dir = 1) {\n        if (!this.active) return false;\n        const nextRot = (this.active.rot + (dir > 0 ? 1 : 3)) % 4;\n\n        // Minimal wall-kick set (enough for bootstrap).\n        const kicks = [\n            { x: 0, y: 0 },\n            { x: -1, y: 0 },\n            { x: 1, y: 0 },\n            { x: 0, y: -1 },\n            { x: -2, y: 0 },\n            { x: 2, y: 0 }\n        ];\n\n        for (const k of kicks) {\n            const nx = this.active.x + k.x;\n            const ny = this.active.y + k.y;\n            if (this._canPlace(this.active.type, nx, ny, nextRot)) {\n                this.active.x = nx;\n                this.active.y = ny;\n                this.active.rot = nextRot;\n                return true;\n            }\n        }\n        return false;\n    }\n\n    hardDrop() {\n        if (!this.active) return { locked: false, linesCleared: 0 };\n        while (this._canPlace(this.active.type, this.active.x, this.active.y + 1, this.active.rot)) {\n            this.active.y++;\n        }\n        const lockRes = this.lockActive();\n        return lockRes;\n    }\n\n    holdPiece() {\n        if (!this.active || this.holdUsed) return false;\n        const current = this.active.type;\n        if (!this.hold) {\n            this.hold = current;\n            this.spawnPiece();\n        } else {\n            const swap = this.hold;\n            this.hold = current;\n            this._spawnSpecific(swap);\n        }\n        this.holdUsed = true;\n        return true;\n    }\n\n    lockActive() {\n        if (!this.active) return { locked: false, linesCleared: 0 };\n\n        const blocks = this._getBlocks(this.active.type, this.active.rot);\n        for (const b of blocks) {\n            const x = this.active.x + b.x;\n            const y = this.active.y + b.y;\n            if (y < 0) {\n                this.gameOver = true;\n                return { locked: false, linesCleared: 0 };\n            }\n            this.grid[y][x] = { type: this.active.type };\n        }\n\n        const linesCleared = this._clearLines();\n        this.spawnPiece();\n        return { locked: true, linesCleared };\n    }\n\n    // ==================================================\n    // BOARDSystem surface (stubs or simple impl)\n    // ==================================================\n\n    isNearOverflow() {\n        // Simple: overflow if any block in top 2 rows.\n        for (let y = 0; y < 2; y++) {\n            for (let x = 0; x < this.width; x++) {\n                if (this.grid[y][x]) return true;\n            }\n        }\n        return false;\n    }\n\n    findCriticalZones() {\n        // Bootstrap: return empty set.\n        return [];\n    }\n\n    smoothSurface() {\n        // Bootstrap: no-op.\n    }\n\n    smoothZone(_zone) {\n        // Bootstrap: no-op.\n    }\n\n    selectDestructionTargets(count) {\n        // Deterministic scan from bottom.\n        const targets = [];\n        for (let y = this.height - 1; y >= 0; y--) {\n            for (let x = 0; x < this.width; x++) {\n                if (this.grid[y][x]) {\n                    targets.push({ x, y });\n                    if (targets.length >= count) return targets;\n                }\n            }\n        }\n        return targets;\n    }\n\n    clearCell(cell) {\n        if (!cell) return;\n        const { x, y } = cell;\n        if (y >= 0 && y < this.height && x >= 0 && x < this.width) {\n            this.grid[y][x] = null;\n        }\n    }\n\n    selectRandomTargets(count) {\n        const filled = [];\n        for (let y = 0; y < this.height; y++) {\n            for (let x = 0; x < this.width; x++) {\n                if (this.grid[y][x]) filled.push({ x, y });\n            }\n        }\n        const out = [];\n        for (let i = 0; i < count && filled.length > 0; i++) {\n            const idx = Math.floor(this._rng() * filled.length);\n            out.push(filled.splice(idx, 1)[0]);\n        }\n        return out;\n    }\n\n    selectMassiveDestructionZones() {\n        // Bootstrap: clear bottom half as one zone.\n        return [{ y0: Math.floor(this.height / 2), y1: this.height - 1 }];\n    }\n\n    clearZone(zone) {\n        if (!zone) return;\n        const y0 = Math.max(0, zone.y0 ?? 0);\n        const y1 = Math.min(this.height - 1, zone.y1 ?? this.height - 1);\n        for (let y = y0; y <= y1; y++) {\n            for (let x = 0; x < this.width; x++) {\n                this.grid[y][x] = null;\n            }\n        }\n    }\n\n    completeNearestLine() {\n        // Bootstrap: find a line with >= width-1 blocks and fill it.\n        for (let y = this.height - 1; y >= 0; y--) {\n            let filled = 0;\n            for (let x = 0; x < this.width; x++) if (this.grid[y][x]) filled++;\n            if (filled >= this.width - 1) {\n                for (let x = 0; x < this.width; x++) this.grid[y][x] = { type: 'I' };\n                this._clearLines();\n                return;\n            }\n        }\n    }\n\n    clearInstabilityFlags() {\n        // Bootstrap: no-op.\n    }\n\n    // ==================================================\n    // INTERNAL\n    // ==================================================\n\n    spawnPiece() {\n        this.holdUsed = false;\n\n        const type = this._nextFromBag();\n        this._spawnSpecific(type);\n    }\n\n    _spawnSpecific(type) {\n        const spawnX = Math.floor(this.width / 2);\n        const spawnY = 0;\n        const rot = 0;\n\n        const candidate = { type, x: spawnX, y: spawnY, rot };\n        if (!this._canPlace(type, candidate.x, candidate.y, candidate.rot)) {\n            // Try slightly higher spawn for tall stacks.\n            candidate.y = -1;\n        }\n        if (!this._canPlace(type, candidate.x, candidate.y, candidate.rot)) {\n            this.gameOver = true;\n            this.active = null;\n            return;\n        }\n\n        this.active = candidate;\n    }\n\n    _stepDown() {\n        if (!this.active) return { moved: false, touchedGround: false };\n        if (this._canPlace(this.active.type, this.active.x, this.active.y + 1, this.active.rot)) {\n            this.active.y += 1;\n            return { moved: true, touchedGround: false };\n        }\n        return { moved: false, touchedGround: true };\n    }\n\n    _clearLines() {\n        let cleared = 0;\n        for (let y = this.height - 1; y >= 0; y--) {\n            let full = true;\n            for (let x = 0; x < this.width; x++) {\n                if (!this.grid[y][x]) {\n                    full = false;\n                    break;\n                }\n            }\n            if (full) {\n                this.grid.splice(y, 1);\n                this.grid.unshift(Array.from({ length: this.width }, () => null));\n                cleared++;\n                y++; // re-check this index after shift\n            }\n        }\n        return cleared;\n    }\n\n    _getBlocks(type, rot) {\n        const arr = PIECES[type] ?? PIECES.I;\n        return arr[rot % 4];\n    }\n\n    _canPlace(type, x, y, rot) {\n        const blocks = this._getBlocks(type, rot);\n        for (const b of blocks) {\n            const px = x + b.x;\n            const py = y + b.y;\n            if (px < 0 || px >= this.width) return false;\n            if (py >= this.height) return false;\n            if (py >= 0 && this.grid[py][px]) return false;\n        }\n        return true;\n    }\n\n    _nextFromBag() {\n        if (this._bag.length === 0) {\n            this._bag = Object.keys(PIECES);\n            // Fisher-Yates shuffle using deterministic RNG.\n            for (let i = this._bag.length - 1; i > 0; i--) {\n                const j = Math.floor(this._rng() * (i + 1));\n                const t = this._bag[i];\n                this._bag[i] = this._bag[j];\n                this._bag[j] = t;\n            }\n        }\n        return this._bag.pop();\n    }\n}","/**\r\n * CanvasRenderLoop\r\n *\r\n * RESPONSIBILITY:\r\n * Central requestAnimationFrame loop for all Canvas renderers.\r\n *\r\n * Canon:\r\n * - Stage 5.0 — Gameplay Visual Layer\r\n * - Game logic is authoritative\r\n * - Render loop is purely visual\r\n *\r\n * Design goals:\r\n * - Single rAF loop (no multiple competing loops)\r\n * - Dirty-flag based rendering\r\n * - Safe start / stop lifecycle\r\n */\r\n\r\nexport class CanvasRenderLoop {\r\n\r\n    constructor() {\r\n        this.renderers = new Set();\r\n        this.isRunning = false;\r\n        this.rafId = null;\r\n\r\n        this._boundTick = this._tick.bind(this);\r\n    }\r\n\r\n    // ---------------------------------------------------------------------\r\n    // REGISTRATION\r\n    // ---------------------------------------------------------------------\r\n\r\n    /**\r\n     * Register a renderer that exposes:\r\n     * - render()\r\n     * - needsRedraw (boolean)\r\n     */\r\n    register(renderer) {\r\n        if (!renderer || typeof renderer.render !== 'function') {\r\n            console.warn('[CanvasRenderLoop] Invalid renderer registered', renderer);\r\n            return;\r\n        }\r\n\r\n        this.renderers.add(renderer);\r\n        this._ensureRunning();\r\n    }\r\n\r\n    unregister(renderer) {\r\n        if (!renderer) return;\r\n\r\n        this.renderers.delete(renderer);\r\n\r\n        if (this.renderers.size === 0) {\r\n            this._stop();\r\n        }\r\n    }\r\n\r\n    // ---------------------------------------------------------------------\r\n    // LOOP CONTROL\r\n    // ---------------------------------------------------------------------\r\n\r\n    _ensureRunning() {\r\n        if (this.isRunning) return;\r\n\r\n        this.isRunning = true;\r\n        this.rafId = requestAnimationFrame(this._boundTick);\r\n    }\r\n\r\n    _stop() {\r\n        if (!this.isRunning) return;\r\n\r\n        cancelAnimationFrame(this.rafId);\r\n        this.rafId = null;\r\n        this.isRunning = false;\r\n    }\r\n\r\n    // ---------------------------------------------------------------------\r\n    // MAIN TICK\r\n    // ---------------------------------------------------------------------\r\n\r\n    _tick() {\r\n        if (!this.isRunning) return;\r\n\r\n        let needsAnotherFrame = false;\r\n\r\n        for (const renderer of this.renderers) {\r\n            if (renderer.needsRedraw) {\r\n                renderer.render();\r\n                needsAnotherFrame = true;\r\n            }\r\n        }\r\n\r\n        // Continue loop only if someone still needs redraw\r\n        if (needsAnotherFrame) {\r\n            this.rafId = requestAnimationFrame(this._boundTick);\r\n        } else {\r\n            // Go idle until next dirty flag\r\n            this.isRunning = false;\r\n            this.rafId = null;\r\n        }\r\n    }\r\n\r\n    // ---------------------------------------------------------------------\r\n    // PUBLIC API\r\n    // ---------------------------------------------------------------------\r\n\r\n    /**\r\n     * Forces a redraw on all registered renderers.\r\n     * Useful for resize, theme change, etc.\r\n     */\r\n    requestFullRedraw() {\r\n        for (const renderer of this.renderers) {\r\n            renderer.needsRedraw = true;\r\n        }\r\n        this._ensureRunning();\r\n    }\r\n\r\n    /**\r\n     * Stop loop completely (e.g. on scene unload).\r\n     */\r\n    destroy() {\r\n        this._stop();\r\n        this.renderers.clear();\r\n    }\r\n}\r\n","/**\r\n * BoardLayer\r\n *\r\n * RESPONSIBILITY:\r\n * Visual-only rendering layer for the board grid and static blocks.\r\n *\r\n * Canon:\r\n * - Stage 5.0 — Gameplay Visual Layer\r\n * - Canvas-only implementation\r\n * - No gameplay logic\r\n *\r\n * BoardLayer:\r\n * - draws grid\r\n * - draws occupied cells\r\n * - reacts to board snapshots\r\n *\r\n * Does NOT:\r\n * - move pieces\r\n * - animate\r\n * - apply effects\r\n */\r\n\r\nexport class BoardLayer {\r\n\r\n    constructor({\r\n        ctx,\r\n        config\r\n    }) {\r\n        this.ctx = ctx;\r\n        this.config = config;\r\n\r\n        this.lastSnapshot = null;\r\n    }\r\n\r\n    // -----------------------------------------------------------------\r\n    // SNAPSHOT UPDATE\r\n    // -----------------------------------------------------------------\r\n\r\n    /**\r\n     * Update board snapshot for rendering.\r\n     * @param {Object} snapshot\r\n     */\r\n    updateSnapshot(snapshot) {\r\n        this.lastSnapshot = snapshot;\r\n    }\r\n\r\n    // -----------------------------------------------------------------\r\n    // RENDER\r\n    // -----------------------------------------------------------------\r\n\r\n    /**\r\n     * Render grid and blocks based on the last snapshot.\r\n     */\r\n    render() {\r\n        if (!this.lastSnapshot) return;\r\n\r\n        const { width, height } = this.lastSnapshot;\r\n        const cellSize = this._getCellSize(width, height);\r\n\r\n        if (this.config.grid.showGrid) {\r\n            this._drawGrid(width, height, cellSize);\r\n        }\r\n\r\n        this._drawCells(width, height, cellSize);\r\n    }\r\n\r\n    // -----------------------------------------------------------------\r\n    // GRID\r\n    // -----------------------------------------------------------------\r\n\r\n    _drawGrid(width, height, cellSize) {\r\n        const { ctx } = this;\r\n\r\n        ctx.save();\r\n        ctx.strokeStyle = this.config.colors.grid;\r\n        ctx.lineWidth = this.config.grid.lineWidth;\r\n\r\n        for (let y = 0; y <= height; y++) {\r\n            const py = y * cellSize;\r\n            ctx.beginPath();\r\n            ctx.moveTo(0, py);\r\n            ctx.lineTo(width * cellSize, py);\r\n            ctx.stroke();\r\n        }\r\n\r\n        for (let x = 0; x <= width; x++) {\r\n            const px = x * cellSize;\r\n            ctx.beginPath();\r\n            ctx.moveTo(px, 0);\r\n            ctx.lineTo(px, height * cellSize);\r\n            ctx.stroke();\r\n        }\r\n\r\n        ctx.restore();\r\n    }\r\n\r\n    // -----------------------------------------------------------------\r\n    // CELLS\r\n    // -----------------------------------------------------------------\r\n\r\n    _drawCells(width, height, cellSize) {\r\n        const { ctx } = this;\r\n        const cells = this.lastSnapshot.cells;\r\n\r\n        for (let y = 0; y < height; y++) {\r\n            for (let x = 0; x < width; x++) {\r\n                const cell = cells[y][x];\r\n                if (!cell || cell.isEmpty) continue;\r\n\r\n                this._drawCell(x, y, cell, cellSize);\r\n            }\r\n        }\r\n    }\r\n\r\n    _drawCell(x, y, cell, cellSize) {\r\n        const { ctx } = this;\r\n        const radius = this.config.cell.cornerRadius;\r\n\r\n        ctx.save();\r\n        ctx.fillStyle =\r\n            this.config.colors.blocks[cell.type] ||\r\n            this.config.colors.blocks.default;\r\n\r\n        const px = x * cellSize;\r\n        const py = y * cellSize;\r\n\r\n        this._drawRoundedRect(\r\n            px,\r\n            py,\r\n            cellSize,\r\n            cellSize,\r\n            radius\r\n        );\r\n\r\n        ctx.restore();\r\n    }\r\n\r\n    // -----------------------------------------------------------------\r\n    // UTILITIES\r\n    // -----------------------------------------------------------------\r\n\r\n    _getCellSize(width, height) {\r\n        // BoardLayer assumes canvas already sized correctly\r\n        const availableWidth = this.ctx.canvas.width;\r\n        const availableHeight = this.ctx.canvas.height;\r\n\r\n        const cellWidth = availableWidth / width;\r\n        const cellHeight = availableHeight / height;\r\n\r\n        return Math.min(cellWidth, cellHeight) * this.config.cell.scale;\r\n    }\r\n\r\n    _drawRoundedRect(x, y, w, h, r) {\r\n        const { ctx } = this;\r\n\r\n        ctx.beginPath();\r\n        ctx.moveTo(x + r, y);\r\n        ctx.lineTo(x + w - r, y);\r\n        ctx.quadraticCurveTo(x + w, y, x + w, y + r);\r\n        ctx.lineTo(x + w, y + h - r);\r\n        ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);\r\n        ctx.lineTo(x + r, y + h);\r\n        ctx.quadraticCurveTo(x, y + h, x, y + h - r);\r\n        ctx.lineTo(x, y + r);\r\n        ctx.quadraticCurveTo(x, y, x + r, y);\r\n        ctx.closePath();\r\n        ctx.fill();\r\n    }\r\n}\r\n","/**\r\n * PieceAnimator\r\n *\r\n * RESPONSIBILITY:\r\n * Handles smooth visual interpolation of piece position and rotation.\r\n *\r\n * Canon:\r\n * - Stage 5.0.2.1 — Piece Animation\r\n * - Visual-only\r\n * - Logic is authoritative\r\n *\r\n * This class:\r\n * - interpolates between previous and target snapshot\r\n * - does NOT know about collisions or gravity\r\n */\r\n\r\nexport class PieceAnimator {\r\n\r\n    constructor() {\r\n        this.current = null;\r\n        this.target = null;\r\n\r\n        this.animationTime = 0;\r\n        this.duration = 120; // ms, visual smoothing window\r\n    }\r\n\r\n    // -----------------------------------------------------------------\r\n    // SNAPSHOT UPDATE\r\n    // -----------------------------------------------------------------\r\n\r\n    /**\r\n     * Called when logical piece state updates.\r\n     * @param {Object} snapshot\r\n     */\r\n    setTarget(snapshot) {\r\n        if (!this.current) {\r\n            // First frame: snap directly\r\n            this.current = this._clone(snapshot);\r\n            this.target = this._clone(snapshot);\r\n            this.animationTime = 0;\r\n            return;\r\n        }\r\n\r\n        this.current = this.getInterpolated();\r\n        this.target = this._clone(snapshot);\r\n        this.animationTime = 0;\r\n    }\r\n\r\n    // -----------------------------------------------------------------\r\n    // UPDATE\r\n    // -----------------------------------------------------------------\r\n\r\n    /**\r\n     * Advance animation timer.\r\n     * @param {number} deltaMs\r\n     */\r\n    update(deltaMs) {\r\n        if (!this.target) return;\r\n\r\n        this.animationTime += deltaMs;\r\n        if (this.animationTime > this.duration) {\r\n            this.animationTime = this.duration;\r\n        }\r\n    }\r\n\r\n    // -----------------------------------------------------------------\r\n    // INTERPOLATION\r\n    // -----------------------------------------------------------------\r\n\r\n    getInterpolated() {\r\n        if (!this.current || !this.target) return null;\r\n\r\n        const t = Math.min(this.animationTime / this.duration, 1);\r\n\r\n        return {\r\n            type: this.target.type,\r\n            blocks: this.target.blocks,\r\n            rotation: this._lerpAngle(\r\n                this.current.rotation,\r\n                this.target.rotation,\r\n                t\r\n            ),\r\n            position: {\r\n                x: this._lerp(this.current.position.x, this.target.position.x, t),\r\n                y: this._lerp(this.current.position.y, this.target.position.y, t)\r\n            }\r\n        };\r\n    }\r\n\r\n    // -----------------------------------------------------------------\r\n    // UTILITIES\r\n    // -----------------------------------------------------------------\r\n\r\n    _lerp(a, b, t) {\r\n        return a + (b - a) * t;\r\n    }\r\n\r\n    _lerpAngle(a, b, t) {\r\n        let diff = b - a;\r\n        if (diff > Math.PI) diff -= Math.PI * 2;\r\n        if (diff < -Math.PI) diff += Math.PI * 2;\r\n        return a + diff * t;\r\n    }\r\n\r\n    _clone(obj) {\r\n        return JSON.parse(JSON.stringify(obj));\r\n    }\r\n\r\n    // -----------------------------------------------------------------\r\n    // PUBLIC API\r\n    // -----------------------------------------------------------------\r\n\r\n    reset() {\r\n        this.current = null;\r\n        this.target = null;\r\n        this.animationTime = 0;\r\n    }\r\n}\r\n","/**\r\n * DropAnimator\r\n *\r\n * RESPONSIBILITY:\r\n * Visual-only handling of soft drop and hard drop animations.\r\n *\r\n * Canon:\r\n * - Stage 5.0.2.2 — Drop Animations\r\n * - Logic authoritative\r\n * - Visual layer reacts to events only\r\n *\r\n * This animator modifies vertical interpolation speed and\r\n * applies short-lived impulses for hard drop.\r\n */\r\n\r\nexport class DropAnimator {\r\n\r\n    constructor() {\r\n        // Multipliers applied to visual interpolation\r\n        this.softDropMultiplier = 1.0;\r\n        this.hardDropImpulse = 0;\r\n\r\n        // Timing\r\n        this.hardDropDuration = 80; // ms\r\n        this.hardDropTime = 0;\r\n    }\r\n\r\n    // -----------------------------------------------------------------\r\n    // EVENTS\r\n    // -----------------------------------------------------------------\r\n\r\n    onSoftDropStart() {\r\n        // Increase visual falling speed\r\n        this.softDropMultiplier = 2.5;\r\n    }\r\n\r\n    onSoftDropEnd() {\r\n        this.softDropMultiplier = 1.0;\r\n    }\r\n\r\n    onHardDrop() {\r\n        // Trigger a short visual impulse\r\n        this.hardDropImpulse = 1.0;\r\n        this.hardDropTime = 0;\r\n    }\r\n\r\n    // -----------------------------------------------------------------\r\n    // UPDATE\r\n    // -----------------------------------------------------------------\r\n\r\n    /**\r\n     * Update animator state.\r\n     * @param {number} deltaMs\r\n     */\r\n    update(deltaMs) {\r\n        if (this.hardDropImpulse > 0) {\r\n            this.hardDropTime += deltaMs;\r\n            const t = Math.min(this.hardDropTime / this.hardDropDuration, 1);\r\n\r\n            // Ease-out impulse\r\n            this.hardDropImpulse = 1 - t;\r\n\r\n            if (t >= 1) {\r\n                this.hardDropImpulse = 0;\r\n                this.hardDropTime = 0;\r\n            }\r\n        }\r\n    }\r\n\r\n    // -----------------------------------------------------------------\r\n    // APPLICATION\r\n    // -----------------------------------------------------------------\r\n\r\n    /**\r\n     * Apply drop modifiers to interpolated Y position.\r\n     * @param {number} y\r\n     * @param {number} deltaMs\r\n     */\r\n    apply(y, deltaMs) {\r\n        let result = y;\r\n\r\n        // Soft drop: accelerate downward movement\r\n        if (this.softDropMultiplier > 1) {\r\n            result += (deltaMs / 16) * (this.softDropMultiplier - 1);\r\n        }\r\n\r\n        // Hard drop: add short impulse\r\n        if (this.hardDropImpulse > 0) {\r\n            result += this.hardDropImpulse * 0.6;\r\n        }\r\n\r\n        return result;\r\n    }\r\n\r\n    // -----------------------------------------------------------------\r\n    // RESET\r\n    // -----------------------------------------------------------------\r\n\r\n    reset() {\r\n        this.softDropMultiplier = 1.0;\r\n        this.hardDropImpulse = 0;\r\n        this.hardDropTime = 0;\r\n    }\r\n}\r\n","import { PieceAnimator } from './PieceAnimator.js';\r\nimport { DropAnimator } from './DropAnimator.js';\r\n\r\n/**\r\n * PieceLayer\r\n *\r\n * RESPONSIBILITY:\r\n * Visual-only rendering of:\r\n * - active falling piece (with animation)\r\n * - ghost piece (static)\r\n *\r\n * Canon:\r\n * - Stage 5.0.2 — Piece Animation System\r\n * - Stage 5.0.2.2 — Hard / Soft Drop Animation\r\n * - Canvas-only\r\n * - Logic authoritative\r\n *\r\n * PieceLayer:\r\n * - does NOT move pieces\r\n * - does NOT validate placement\r\n * - does NOT rotate pieces\r\n *\r\n * It only renders visual interpolation of logic snapshots.\r\n */\r\n\r\nexport class PieceLayer {\r\n\r\n    constructor({\r\n        ctx,\r\n        config\r\n    }) {\r\n        this.ctx = ctx;\r\n        this.config = config;\r\n\r\n        // Visual animators (visual-only)\r\n        this.animator = new PieceAnimator();\r\n        this.dropAnimator = new DropAnimator();\r\n\r\n        // Snapshots\r\n        this.activePiece = null;\r\n        this.ghostPiece = null;\r\n\r\n        // Internal timing (provided by render loop)\r\n        this._deltaMs = 0;\r\n    }\r\n\r\n    // -----------------------------------------------------------------\r\n    // SNAPSHOT UPDATE\r\n    // -----------------------------------------------------------------\r\n\r\n    updateActivePiece(pieceSnapshot) {\r\n        this.activePiece = pieceSnapshot;\r\n\r\n        if (pieceSnapshot) {\r\n            this.animator.setTarget(pieceSnapshot);\r\n        } else {\r\n            this.animator.reset();\r\n        }\r\n    }\r\n\r\n    updateGhostPiece(ghostSnapshot) {\r\n        this.ghostPiece = ghostSnapshot;\r\n    }\r\n\r\n    // -----------------------------------------------------------------\r\n    // RENDER\r\n    // -----------------------------------------------------------------\r\n\r\n    render(cellSize, deltaMs = 16) {\r\n        if (!cellSize) return;\r\n\r\n        this._deltaMs = deltaMs;\r\n\r\n        this.animator.update(deltaMs);\r\n        this.dropAnimator.update(deltaMs);\r\n\r\n        // Ghost piece first\r\n        if (this.ghostPiece) {\r\n            this._drawPiece(this.ghostPiece, cellSize, true);\r\n        }\r\n\r\n        const animatedPiece = this.animator.getInterpolated();\r\n        if (animatedPiece) {\r\n            animatedPiece.position.y = this.dropAnimator.apply(\r\n                animatedPiece.position.y,\r\n                deltaMs\r\n            );\r\n\r\n            this._drawPiece(animatedPiece, cellSize, false);\r\n        }\r\n    }\r\n\r\n    // -----------------------------------------------------------------\r\n    // DRAWING\r\n    // -----------------------------------------------------------------\r\n\r\n    _drawPiece(piece, cellSize, isGhost) {\r\n        const { ctx } = this;\r\n        const { blocks, type, position } = piece;\r\n\r\n        ctx.save();\r\n\r\n        const baseColor =\r\n            this.config.colors.blocks[type] ||\r\n            this.config.colors.blocks.default;\r\n\r\n        ctx.fillStyle = isGhost\r\n            ? this._applyGhostStyle(baseColor)\r\n            : baseColor;\r\n\r\n        for (const block of blocks) {\r\n            const x = (position.x + block.x) * cellSize;\r\n            const y = (position.y + block.y) * cellSize;\r\n\r\n            this._drawBlock(x, y, cellSize);\r\n        }\r\n\r\n        ctx.restore();\r\n    }\r\n\r\n    _drawBlock(x, y, size) {\r\n        const r = this.config.cell.cornerRadius;\r\n        const ctx = this.ctx;\r\n\r\n        ctx.beginPath();\r\n        ctx.moveTo(x + r, y);\r\n        ctx.lineTo(x + size - r, y);\r\n        ctx.quadraticCurveTo(x + size, y, x + size, y + r);\r\n        ctx.lineTo(x + size, y + size - r);\r\n        ctx.quadraticCurveTo(x + size, y + size, x + size - r, y + size);\r\n        ctx.lineTo(x + r, y + size);\r\n        ctx.quadraticCurveTo(x, y + size, x, y + size - r);\r\n        ctx.lineTo(x, y + r);\r\n        ctx.quadraticCurveTo(x, y, x + r, y);\r\n        ctx.closePath();\r\n        ctx.fill();\r\n    }\r\n\r\n    // -----------------------------------------------------------------\r\n    // GHOST STYLE\r\n    // -----------------------------------------------------------------\r\n\r\n    _applyGhostStyle(color) {\r\n        if (!color.startsWith('#')) return color;\r\n\r\n        const r = parseInt(color.slice(1, 3), 16);\r\n        const g = parseInt(color.slice(3, 5), 16);\r\n        const b = parseInt(color.slice(5, 7), 16);\r\n\r\n        return `rgba(${r}, ${g}, ${b}, 0.25)`;\r\n    }\r\n\r\n    // -----------------------------------------------------------------\r\n    // PUBLIC API\r\n    // -----------------------------------------------------------------\r\n\r\n    clear() {\r\n        this.activePiece = null;\r\n        this.ghostPiece = null;\r\n        this.animator.reset();\r\n        this.dropAnimator.reset();\r\n    }\r\n}\r\n","class FXPriority {\n  static CRITICAL = 1000;\n  static HIGH = 750;\n  static MEDIUM = 500;\n  static LOW = 250;\n  static BACKGROUND = 100;\n\n  static clamp(v) {\n    if (v < FXPriority.BACKGROUND) return FXPriority.BACKGROUND;\n    if (v > FXPriority.CRITICAL) return FXPriority.CRITICAL;\n    return v;\n  }\n}\n\nexport { FXPriority };\nexport default FXPriority;\n","// client/gameplay/canvas/fx/FXBudgetController.js\n// FX budget controller (limits concurrent FX load)\n\nimport FXPriority from \"./FXPriority.js\";\n\nclass FXBudgetController {\n  constructor({\n    maxActiveFX = 12,\n    softLimit = 8\n  } = {}) {\n    this.maxActiveFX = maxActiveFX;\n    this.softLimit = softLimit;\n    this.activeFX = [];\n  }\n\n  /**\n   * Try to register FX instance\n   * @param {{ priority:number, id?:string }} fx\n   * @returns {boolean} accepted\n   */\n  tryRegister(fx) {\n    if (!fx || typeof fx.priority !== \"number\") return false;\n\n    fx.priority = FXPriority.clamp(fx.priority);\n\n    // Under soft limit → always accept\n    if (this.activeFX.length < this.softLimit) {\n      this.activeFX.push(fx);\n      return true;\n    }\n\n    // Hard cap reached → reject low priority\n    if (this.activeFX.length >= this.maxActiveFX) {\n      const lowest = this._findLowestPriority();\n      if (!lowest || lowest.priority >= fx.priority) {\n        return false;\n      }\n      this._remove(lowest);\n    }\n\n    this.activeFX.push(fx);\n    return true;\n  }\n\n  unregister(fx) {\n    this._remove(fx);\n  }\n\n  clear() {\n    this.activeFX.length = 0;\n  }\n\n  _findLowestPriority() {\n    let lowest = null;\n    for (const fx of this.activeFX) {\n      if (!lowest || fx.priority < lowest.priority) lowest = fx;\n    }\n    return lowest;\n  }\n\n  _remove(fx) {\n    const idx = this.activeFX.indexOf(fx);\n    if (idx !== -1) this.activeFX.splice(idx, 1);\n  }\n}\n\n// IMPORTANT: provide BOTH named + default exports\nexport { FXBudgetController };\nexport default FXBudgetController;\n","// client/gameplay/canvas/CanvasBoardRenderer.js\r\n\r\nimport { BoardLayer } from './BoardLayer.js';\r\nimport { PieceLayer } from './PieceLayer.js';\r\n\r\nimport { FXBudgetController } from './fx/FXBudgetController.js';\r\nimport { FXPriority } from './fx/FXPriority.js';\r\n\r\n/**\r\n * CanvasBoardRenderer\r\n * ----------------------------------------------------\r\n * Central orchestrator for all canvas-based rendering.\r\n *\r\n * RESPONSIBILITIES:\r\n * - Board rendering\r\n * - Piece rendering\r\n * - FX rendering with priority & intensity control\r\n *\r\n * HARD CANON:\r\n * - No gameplay logic\r\n * - No timing logic\r\n * - Visual-only\r\n */\r\n\r\nexport class CanvasBoardRenderer {\r\n\r\n    constructor({\r\n        rootElement,\r\n        boardSystem,\r\n        eventBus,\r\n        config,\r\n        renderLoop,\r\n        vfxIntensity = 'MED'\r\n    }) {\r\n        // --- Guardrails / defaults (do not change canonical responsibilities) ---\r\n        // rootElement is mandatory for DOM attach; fallback to body to prevent hard crash.\r\n        this.rootElement = rootElement || document.getElementById('gameRoot') || document.body;\r\n\r\n        this.boardSystem = boardSystem;\r\n        this.eventBus = eventBus;\r\n        this.config = config;\r\n\r\n        // renderLoop is optional for Stage 6.1.A bootstrap.\r\n        // If not provided, use an internal minimal loop that calls render() on RAF.\r\n        this.renderLoop = renderLoop || this._createFallbackRenderLoop();\r\n\r\n        /* ==============================\r\n           CANVAS\r\n        ============================== */\r\n\r\n        this.canvas = null;\r\n        this.ctx = null;\r\n\r\n        /* ==============================\r\n           CORE LAYERS\r\n        ============================== */\r\n\r\n        this.boardLayer = null;\r\n        this.pieceLayer = null;\r\n\r\n        /* ==============================\r\n           FX SYSTEM\r\n        ============================== */\r\n\r\n        this.fxLayers = []; // { layer, priority }\r\n\r\n        // Keep intensity param, but initialize FXBudgetController safely:\r\n        // - Some implementations accept an options object\r\n        // - Some accept intensity token\r\n        // We normalize to an options object, while preserving vfxIntensity semantics.\r\n        this.vfxIntensity = vfxIntensity;\r\n        this.fxBudget = this._createFXBudgetController(vfxIntensity);\r\n\r\n        /* ==============================\r\n           STATE\r\n        ============================== */\r\n\r\n        this.needsRedraw = true;\r\n\r\n        // Ensure rootElement exists before DOM operations\r\n        if (!this.rootElement) {\r\n            throw new Error('CanvasBoardRenderer: rootElement is required (provide #gameRoot or document.body).');\r\n        }\r\n\r\n        this._initCanvas();\r\n        this._initLayers();\r\n        this._bindEvents();\r\n        this._resize();\r\n\r\n        // Register into render loop (safe even for fallback)\r\n        this.renderLoop.register(this);\r\n        this._requestRedraw();\r\n    }\r\n\r\n    /* ==================================================\r\n       INITIALIZATION\r\n    ================================================== */\r\n\r\n    _initCanvas() {\r\n        this.canvas = document.createElement('canvas');\r\n        this.canvas.classList.add('gameplay-canvas');\r\n\r\n        this.ctx = this.canvas.getContext('2d', {\r\n            alpha: false,\r\n            desynchronized: true\r\n        });\r\n\r\n        // Guard against undefined rootElement (original crash point)\r\n        // If rootElement is not an Element, fallback to body.\r\n        const target =\r\n            (this.rootElement && this.rootElement.appendChild)\r\n                ? this.rootElement\r\n                : document.body;\r\n\r\n        target.appendChild(this.canvas);\r\n    }\r\n\r\n    _initLayers() {\r\n        this.boardLayer = new BoardLayer({\r\n            ctx: this.ctx,\r\n            config: this.config\r\n        });\r\n\r\n        this.pieceLayer = new PieceLayer({\r\n            ctx: this.ctx,\r\n            config: this.config\r\n        });\r\n    }\r\n\r\n    /* ==================================================\r\n       FX REGISTRATION (CALLED EXTERNALLY)\r\n    ================================================== */\r\n\r\n    registerFXLayer(layer, priority) {\r\n        // Keep canonical API, but sanitize inputs\r\n        const safePriority =\r\n            typeof priority === 'number'\r\n                ? priority\r\n                : (FXPriority && FXPriority.MEDIUM ? FXPriority.MEDIUM : 500);\r\n\r\n        this.fxLayers.push({ layer, priority: safePriority });\r\n    }\r\n\r\n    /* ==================================================\r\n       EVENTS\r\n    ================================================== */\r\n\r\n    _bindEvents() {\r\n        // EventBus may not be fully wired in Stage 6.1.A. Guard to avoid hard crash.\r\n        if (!this.eventBus || typeof this.eventBus.on !== 'function') {\r\n            // Still allow rendering via render loop; board snapshots may be pulled lazily.\r\n            return;\r\n        }\r\n\r\n        this.eventBus.on('BOARD_UPDATED', () => {\r\n            this._updateBoardSnapshot();\r\n            this._requestRedraw();\r\n        });\r\n\r\n        this.eventBus.on('BOARD_RESET', () => {\r\n            this._updateBoardSnapshot();\r\n            this.pieceLayer.clear();\r\n            this._requestRedraw();\r\n        });\r\n\r\n        this.eventBus.on('PIECE_UPDATED', (pieceSnapshot) => {\r\n            this.pieceLayer.updateActivePiece(pieceSnapshot);\r\n            this._requestRedraw();\r\n        });\r\n\r\n        this.eventBus.on('GHOST_PIECE_UPDATED', (ghostSnapshot) => {\r\n            this.pieceLayer.updateGhostPiece(ghostSnapshot);\r\n            this._requestRedraw();\r\n        });\r\n\r\n        this.eventBus.on('SOFT_DROP_START', () => {\r\n            this.pieceLayer.dropAnimator.onSoftDropStart();\r\n            this._requestRedraw();\r\n        });\r\n\r\n        this.eventBus.on('SOFT_DROP_END', () => {\r\n            this.pieceLayer.dropAnimator.onSoftDropEnd();\r\n            this._requestRedraw();\r\n        });\r\n\r\n        this.eventBus.on('HARD_DROP', () => {\r\n            this.pieceLayer.dropAnimator.onHardDrop();\r\n            this._requestRedraw();\r\n        });\r\n\r\n        window.addEventListener('resize', () => {\r\n            this._resize();\r\n            this._requestRedraw();\r\n        });\r\n    }\r\n\r\n    /* ==================================================\r\n       SNAPSHOT\r\n    ================================================== */\r\n\r\n    _updateBoardSnapshot() {\r\n        // Guard for Stage 6.1.A incremental wiring\r\n        if (!this.boardSystem || typeof this.boardSystem.getBoardSnapshot !== 'function') return;\r\n\r\n        const snapshot = this.boardSystem.getBoardSnapshot();\r\n        if (snapshot) {\r\n            this.boardLayer.updateSnapshot(snapshot);\r\n        }\r\n    }\r\n\r\n    /* ==================================================\r\n       RENDER LOOP\r\n    ================================================== */\r\n\r\n    render(deltaMs = 16) {\r\n        if (!this.needsRedraw) return;\r\n        this.needsRedraw = false;\r\n\r\n        this._clear();\r\n\r\n        /* ------------------------------\r\n           CORE RENDER\r\n        ------------------------------ */\r\n\r\n        // If no events were bound, ensure snapshot is still updated opportunistically\r\n        if (!this.boardLayer.lastSnapshot) {\r\n            this._updateBoardSnapshot();\r\n        }\r\n\r\n        this.boardLayer.render();\r\n\r\n        const snapshot = this.boardLayer.lastSnapshot;\r\n        if (snapshot) {\r\n            const cellSize = this._getCellSize(snapshot);\r\n            this.pieceLayer.render(cellSize, deltaMs);\r\n        }\r\n\r\n        /* ------------------------------\r\n           FX RENDER (BUDGETED)\r\n        ------------------------------ */\r\n\r\n        // Compatibility: if FXBudgetController implementation differs, degrade gracefully.\r\n        const activeFX =\r\n            (this.fxBudget && typeof this.fxBudget.filterFX === 'function')\r\n                ? this.fxBudget.filterFX(this.fxLayers)\r\n                : this.fxLayers;\r\n\r\n        for (const { layer } of activeFX) {\r\n            if (!layer) continue;\r\n\r\n            if (typeof layer.update === 'function') layer.update(deltaMs);\r\n\r\n            this.ctx.save();\r\n\r\n            // Intensity scaling (optional)\r\n            if (this.fxBudget && typeof this.fxBudget.scaleAlpha === 'function') {\r\n                this.ctx.globalAlpha =\r\n                    this.fxBudget.scaleAlpha(this.ctx.globalAlpha || 1);\r\n            }\r\n\r\n            if (typeof layer.render === 'function') {\r\n                layer.render(this.ctx);\r\n            }\r\n\r\n            this.ctx.restore();\r\n        }\r\n    }\r\n\r\n    _requestRedraw() {\r\n        if (!this.needsRedraw) {\r\n            this.needsRedraw = true;\r\n            if (this.renderLoop && typeof this.renderLoop.requestFullRedraw === 'function') {\r\n                this.renderLoop.requestFullRedraw();\r\n            }\r\n        }\r\n    }\r\n\r\n    /* ==================================================\r\n       UTIL\r\n    ================================================== */\r\n\r\n    _clear() {\r\n        if (!this.ctx || !this.canvas) return;\r\n\r\n        this.ctx.fillStyle = this.config?.colors?.background || '#0b0f14';\r\n        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);\r\n    }\r\n\r\n    _getCellSize(snapshot) {\r\n        const w = this.canvas.width / snapshot.width;\r\n        const h = this.canvas.height / snapshot.height;\r\n        return Math.min(w, h);\r\n    }\r\n\r\n    _resize() {\r\n        if (!this.canvas || !this.ctx) return;\r\n\r\n        const rect =\r\n            (this.rootElement && typeof this.rootElement.getBoundingClientRect === 'function')\r\n                ? this.rootElement.getBoundingClientRect()\r\n                : { width: window.innerWidth, height: window.innerHeight };\r\n\r\n        const dpr = window.devicePixelRatio || 1;\r\n\r\n        this.canvas.width = rect.width * dpr;\r\n        this.canvas.height = rect.height * dpr;\r\n\r\n        this.canvas.style.width = `${rect.width}px`;\r\n        this.canvas.style.height = `${rect.height}px`;\r\n\r\n        this.ctx.setTransform(dpr, 0, 0, dpr, 0, 0);\r\n    }\r\n\r\n    destroy() {\r\n        if (this.renderLoop && typeof this.renderLoop.unregister === 'function') {\r\n            this.renderLoop.unregister(this);\r\n        }\r\n\r\n        if (this.canvas && this.canvas.parentNode) {\r\n            this.canvas.parentNode.removeChild(this.canvas);\r\n        }\r\n    }\r\n\r\n    /* ==================================================\r\n       INTERNAL HELPERS\r\n    ================================================== */\r\n\r\n    _createFXBudgetController(vfxIntensity) {\r\n        // Preferred: if FXBudgetController supports options, map intensity to sane budgets.\r\n        // This keeps \"AAA+ FX priority budget\" intent without assuming implementation details.\r\n        const token = (typeof vfxIntensity === 'string') ? vfxIntensity.toUpperCase() : 'MED';\r\n\r\n        const presets = {\r\n            LOW: { maxActiveFX: 6, softLimit: 4 },\r\n            MED: { maxActiveFX: 10, softLimit: 7 },\r\n            HIGH: { maxActiveFX: 14, softLimit: 10 }\r\n        };\r\n\r\n        const opts = presets[token] || presets.MED;\r\n\r\n        try {\r\n            // Most robust: pass options object\r\n            return new FXBudgetController(opts);\r\n        } catch (e) {\r\n            // Fallback: some legacy implementations may accept token directly\r\n            return new FXBudgetController(vfxIntensity);\r\n        }\r\n    }\r\n\r\n    _createFallbackRenderLoop() {\r\n        // Minimal render loop for Stage 6.1.A if system loop isn't wired yet.\r\n        // - register(renderer): stores ref\r\n        // - unregister(renderer): clears ref\r\n        // - requestFullRedraw(): just toggles a flag; RAF will call render()\r\n        let current = null;\r\n        let rafId = null;\r\n\r\n        const tick = (t) => {\r\n            // 16ms default delta for stability; can be replaced later by canonical loop\r\n            if (current && typeof current.render === 'function') current.render(16);\r\n            rafId = window.requestAnimationFrame(tick);\r\n        };\r\n\r\n        return {\r\n            register(renderer) {\r\n                current = renderer;\r\n                if (!rafId) rafId = window.requestAnimationFrame(tick);\r\n            },\r\n            unregister(renderer) {\r\n                if (current === renderer) current = null;\r\n                if (rafId) {\r\n                    window.cancelAnimationFrame(rafId);\r\n                    rafId = null;\r\n                }\r\n            },\r\n            requestFullRedraw() {\r\n                if (current) current.needsRedraw = true;\r\n            }\r\n        };\r\n    }\r\n}\r\n","/**\r\n * CanvasConfig\r\n *\r\n * RESPONSIBILITY:\r\n * Centralized visual configuration for Canvas-based gameplay rendering.\r\n *\r\n * Canon:\r\n * - Stage 5.0 — Gameplay Visual Layer\r\n * - Pure visual parameters only\r\n * - No gameplay logic\r\n *\r\n * This config is intentionally static and declarative.\r\n * Runtime changes should be handled by higher-level systems.\r\n */\r\n\r\nexport const CanvasConfig = {\r\n\r\n    // -----------------------------------------------------------------\r\n    // BOARD DIMENSIONS\r\n    // -----------------------------------------------------------------\r\n\r\n    board: {\r\n        defaultWidth: 10,\r\n        defaultHeight: 20,\r\n\r\n        // Padding around the board inside canvas (in px)\r\n        padding: {\r\n            top: 8,\r\n            right: 8,\r\n            bottom: 8,\r\n            left: 8\r\n        }\r\n    },\r\n\r\n    // -----------------------------------------------------------------\r\n    // CELL VISUALS\r\n    // -----------------------------------------------------------------\r\n\r\n    cell: {\r\n        // Base cell size multiplier (actual size depends on canvas size)\r\n        scale: 1.0,\r\n\r\n        // Border between cells\r\n        gap: 1,\r\n\r\n        // Rounded corners for blocks\r\n        cornerRadius: 2\r\n    },\r\n\r\n    // -----------------------------------------------------------------\r\n    // COLORS (DEFAULT THEME)\r\n    // -----------------------------------------------------------------\r\n\r\n    colors: {\r\n        background: '#0b0e13',\r\n        grid: '#1c2330',\r\n\r\n        emptyCell: '#0b0e13',\r\n\r\n        blocks: {\r\n            I: '#5fd3ff',\r\n            O: '#ffd966',\r\n            T: '#b98cff',\r\n            S: '#7dff8b',\r\n            Z: '#ff6b6b',\r\n            J: '#6b8cff',\r\n            L: '#ff9f43',\r\n\r\n            // Fallback if type is unknown\r\n            default: '#aaaaaa'\r\n        },\r\n\r\n        // Visual warning when board is critical\r\n        criticalOverlay: 'rgba(255, 80, 80, 0.15)'\r\n    },\r\n\r\n    // -----------------------------------------------------------------\r\n    // GRID\r\n    // -----------------------------------------------------------------\r\n\r\n    grid: {\r\n        lineWidth: 1,\r\n        showGrid: true\r\n    },\r\n\r\n    // -----------------------------------------------------------------\r\n    // PERFORMANCE & QUALITY\r\n    // -----------------------------------------------------------------\r\n\r\n    performance: {\r\n        // If true, disable expensive visual features\r\n        lowQualityMode: false\r\n    },\r\n\r\n    // -----------------------------------------------------------------\r\n    // ACCESSIBILITY & SCALING\r\n    // -----------------------------------------------------------------\r\n\r\n    accessibility: {\r\n        // Global visual scale (e.g. for UI zoom)\r\n        globalScale: 1.0,\r\n\r\n        // High contrast mode support (future)\r\n        highContrast: false\r\n    }\r\n};\r\n","// public/js/main.js\r\n// Stage 6.1.A — Live Board Bootstrap (Variant A: build into /public/build)\r\n// MAIN ENTRYPOINT for Vite build\r\n// MAIN_JS_VERSION = 2026-01-10-LIVE-BOARD-A8-FINAL\r\n\r\nimport { initDebug } from \"./debug.js\";\r\n\r\n// Core\r\nimport { EventBus } from \"@client/core/EventBus.js\";\r\nimport { GameLoop } from \"@client/engine/GameLoop.js\";\r\nimport { BoardState } from \"@client/engine/BoardState.js\";\r\n\r\n// Canvas render\r\nimport { CanvasRenderLoop } from \"@client/gameplay/canvas/CanvasRenderLoop.js\";\r\nimport { CanvasBoardRenderer } from \"@client/gameplay/canvas/CanvasBoardRenderer.js\";\r\nimport { CanvasConfig } from \"@client/gameplay/canvas/CanvasConfig.js\";\r\n\r\nconsole.log(\"[BOOT] World of Tetris — Live Board Bootstrap\");\r\nconsole.log('MAIN_JS_VERSION = 2026-01-10-LIVE-BOARD-A8-FINAL');\r\n\r\n// ---------------------------------------------------------------------\r\n// DOM root (ВАЖНО: рендерер сам создаёт canvas и аппендит в rootElement)\r\n// ---------------------------------------------------------------------\r\nconst rootElement =\r\n  document.getElementById(\"gameRoot\") ||\r\n  document.body;\r\n\r\n// ---------------------------------------------------------------------\r\n// Debug init (не ломаем, если выключено)\r\n// ---------------------------------------------------------------------\r\ninitDebug?.();\r\n\r\n// ---------------------------------------------------------------------\r\n// Event bus + State\r\n// ---------------------------------------------------------------------\r\nconst eventBus = new EventBus();\r\n\r\n// BoardState содержит логику спавна/гравитации/локдауна и т.п.\r\nconst boardState = new BoardState({\r\n  width: 10,\r\n  height: 20,\r\n});\r\n\r\n// CanvasBoardRenderer ожидает boardSystem.getBoardSnapshot() для первичного init.\r\n// Делаем тонкий адаптер вокруг boardState.\r\n// ИСПРАВЛЕНИЕ: BoardState использует метод clone(), а не getBoardSnapshot()\r\nconst boardSystem = {\r\n  getBoardSnapshot: () => boardState.clone(),\r\n};\r\n\r\n// ---------------------------------------------------------------------\r\n// Renderer + RenderLoop\r\n// ---------------------------------------------------------------------\r\nconst canvasConfig = (typeof CanvasConfig === 'function') ? new CanvasConfig() : CanvasConfig;\r\nconst renderLoop = new CanvasRenderLoop();\r\n\r\nconst renderer = new CanvasBoardRenderer({\r\n  rootElement,\r\n  eventBus,\r\n  boardSystem,\r\n  canvasConfig,\r\n  renderLoop,\r\n});\r\n\r\n// зарегистрировать рендерер в render loop\r\nrenderLoop.register(renderer);\r\n\r\n// ---------------------------------------------------------------------\r\n// Helpers: публикуем снапшоты в renderer через event bus\r\n// ---------------------------------------------------------------------\r\nfunction publishSnapshots() {\r\n  // BOARD\r\n  eventBus.emit(\"BOARD_UPDATED\", boardState.clone());\r\n\r\n  // ACTIVE PIECE\r\n  eventBus.emit(\"PIECE_UPDATED\", boardState.getActivePieceSnapshot());\r\n\r\n  // GHOST\r\n  eventBus.emit(\"GHOST_UPDATED\", boardState.getGhostPieceSnapshot());\r\n}\r\n\r\n// Первичный рендер\r\npublishSnapshots();\r\n\r\n// ---------------------------------------------------------------------\r\n// Input handling (минимально необходимый слой управления)\r\n// ---------------------------------------------------------------------\r\nconst inputState = {\r\n  softDrop: false,\r\n};\r\n\r\nfunction onKeyDown(e) {\r\n  // не даём странице скроллиться стрелками/пробелом\r\n  const blockKeys = [\"ArrowLeft\", \"ArrowRight\", \"ArrowDown\", \"ArrowUp\", \" \"];\r\n  if (blockKeys.includes(e.key)) e.preventDefault();\r\n\r\n  switch (e.code) {\r\n    case \"ArrowLeft\":\r\n      boardState.move(-1);\r\n      publishSnapshots();\r\n      break;\r\n\r\n    case \"ArrowRight\":\r\n      boardState.move(1);\r\n      publishSnapshots();\r\n      break;\r\n\r\n    case \"ArrowUp\":\r\n    case \"KeyX\":\r\n      boardState.rotate(1);\r\n      publishSnapshots();\r\n      break;\r\n\r\n    case \"KeyZ\":\r\n      boardState.rotate(-1);\r\n      publishSnapshots();\r\n      break;\r\n\r\n    case \"ArrowDown\":\r\n      inputState.softDrop = true;\r\n      break;\r\n\r\n    case \"Space\":\r\n      boardState.hardDrop();\r\n      publishSnapshots();\r\n      break;\r\n\r\n    case \"KeyC\":\r\n      boardState.holdPiece();\r\n      publishSnapshots();\r\n      break;\r\n  }\r\n}\r\n\r\nfunction onKeyUp(e) {\r\n  if (e.code === \"ArrowDown\") {\r\n    inputState.softDrop = false;\r\n  }\r\n}\r\n\r\nwindow.addEventListener(\"keydown\", onKeyDown, { passive: false });\r\nwindow.addEventListener(\"keyup\", onKeyUp, { passive: true });\r\n\r\n// ---------------------------------------------------------------------\r\n// Main game loop: tick board + publish\r\n// ---------------------------------------------------------------------\r\nconst gameLoop = new GameLoop({\r\n  tickRate: 60,\r\n});\r\n\r\ngameLoop.onTick = (dt) => {\r\n  // gameplay tick\r\n  boardState.update(dt, {\r\n    softDrop: inputState.softDrop,\r\n  });\r\n\r\n  // push updates to renderer\r\n  publishSnapshots();\r\n\r\n  // УДАЛЕНО: renderLoop.tick(dt) - этого метода нет!\r\n  // CanvasRenderLoop работает автоматически через requestAnimationFrame\r\n};\r\n\r\ngameLoop.start();\r\n\r\nconsole.log(\"[BOOT] Live Board started successfully\");"],"names":["initDebug","EventBus","eventName","handler","set","payload","err","GameLoop","options","__publicField","now","delta","deltaMs","onTick","maxFps","startPaused","fn","system","s","PIECES","mulberry32","seed","r","BoardState","width","height","row","c","ghost","input","gravityStep","moved","res","dx","nextX","dir","nextRot","kicks","k","nx","ny","current","swap","blocks","b","x","y","linesCleared","_zone","count","targets","cell","filled","out","i","idx","zone","y0","y1","type","spawnX","candidate","cleared","full","rot","px","py","j","t","CanvasRenderLoop","renderer","needsAnotherFrame","BoardLayer","ctx","config","snapshot","cellSize","cells","radius","availableWidth","availableHeight","cellWidth","cellHeight","w","h","PieceAnimator","a","diff","obj","DropAnimator","result","PieceLayer","pieceSnapshot","ghostSnapshot","animatedPiece","piece","isGhost","position","baseColor","block","size","color","g","_FXPriority","v","FXPriority","FXBudgetController","maxActiveFX","softLimit","fx","lowest","CanvasBoardRenderer","rootElement","boardSystem","eventBus","renderLoop","vfxIntensity","layer","priority","safePriority","activeFX","rect","dpr","token","presets","opts","rafId","tick","CanvasConfig","boardState","canvasConfig","publishSnapshots","inputState","onKeyDown","e","onKeyUp","gameLoop","dt"],"mappings":"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"}